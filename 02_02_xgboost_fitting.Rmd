---
title: "02_xgboost_fitting"
output: html_document
date: "2025-05-07"
---


```{r}
reference_date <- as.Date("2015-01-01")

normalize_date_to_days <- function(date_vector) {
  as.numeric(date_vector - reference_date)
}

mv_changed_data <- mv_data %>%
  select(-c(N_claims_year, Date_lapse, Lapse)) 

date_cols <- mv_data %>%
  select(where(is.Date)) %>%
  colnames()

mv_changed_data <- mv_data %>%
    mutate(across(all_of(date_cols), ~ year(.x), .names = "{.col}_year")) %>%
    mutate(across(all_of(date_cols), ~ month(.x), .names = "{.col}_month")) %>%
    mutate(across(all_of(date_cols), ~ day(.x), .names = "{.col}_day")) %>%
  mutate(across(all_of(date_cols), normalize_date_to_days)) 

```



```{r Task and learner}
task_mv = TaskRegr$new(id = "motor_vehicle_claims", backend = mv_data, target = "Cost_claims_year")

learner_xg = lts(lrn("regr.xgboost"))
featureless = lrn("regr.featureless")
```


```{r Set parameter space}
learner_xg$param_set$search_space()
```


```{r}
at_xgboost = auto_tuner(
  tuner = tnr("random_search", batch_size = 100),
  learner = learner_xg,
  resampling = rsmp("cv", folds = 5),
  measure = msr("regr.mse"),
  terminator = trm("evals", n_evals = 50)
)
```


```{r}
design = benchmark_grid(
  tasks = task_mv,
  learners = list(featureless, learner_xg),
  resamplings = rsmp("cv", folds = 5)
)

bmr = benchmark(design)

bmr$aggregate(msr("classif.mse"))
```



```{r}
saveRDS(at, 'lightgbm_rpart.rds')
model <- readRDS('lightgbm_rpart.rds')


model$predict(task_mv, row_ids = split$test)$score()

```




